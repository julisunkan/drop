{% extends "base.html" %}

{% block title %}Community Deals - PriceDrop Tracker{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="text-center mb-5">
        <h1>ðŸ”¥ Top Community Deals Today</h1>
        <p class="lead">Curated deals from our community - upvote the best ones!</p>
    </div>

    <div class="row">
        {% for deal in deals %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card deal-card h-100 shadow-sm">
                <div class="position-relative">
                    <img src="{{ deal.image }}" class="card-img-top" alt="{{ deal.title }}">
                    <div class="discount-badge">{{ deal.discount }}% OFF</div>
                </div>
                
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge marketplace-{{ deal.marketplace.lower() }}">{{ deal.marketplace }}</span>
                        {% if deal.free_shipping %}
                        <span class="badge bg-success">Free Shipping</span>
                        {% endif %}
                    </div>
                    
                    <h5 class="card-title">{{ deal.title }}</h5>
                    
                    <div class="price-section mb-3">
                        <span class="current-price fs-4 fw-bold text-success">
                            ${{ "%.2f"|format(deal.price) }}
                        </span>
                        <span class="original-price text-muted text-decoration-line-through ms-2">
                            ${{ "%.2f"|format(deal.original_price) }}
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-danger upvote-btn {% if deal.user_upvoted %}active{% endif %}" 
                                data-deal-id="{{ deal.id }}">
                            <i class="bi bi-arrow-up-circle-fill"></i>
                            <span class="upvote-count">{{ deal.total_upvotes }}</span>
                        </button>
                        <a href="{{ deal.url }}" class="btn btn-warning btn-sm" target="_blank">
                            View Deal <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-clock"></i> Posted {{ deal.posted_date }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.upvote-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const dealId = parseInt(this.dataset.dealId);
        const countSpan = this.querySelector('.upvote-count');
        
        fetch('/api/community/upvote', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({deal_id: dealId})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const currentCount = parseInt(countSpan.textContent);
                countSpan.textContent = currentCount + 1;
                this.classList.add('active');
            }
        });
    });
});
</script>
{% endblock %}
