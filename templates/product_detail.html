{% extends "base.html" %}

{% block title %}{{ product.name }} - PriceDrop Tracker{% endblock %}

{% block content %}
<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">{{ product.name[:50] }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-6">
            <img src="{{ product.image }}" class="img-fluid rounded shadow" alt="{{ product.name }}">
        </div>
        
        <div class="col-md-6">
            <span class="badge marketplace-{{ product.marketplace.lower() }} mb-2">{{ product.marketplace }}</span>
            
            <h1 class="h3 mb-3">{{ product.name }}</h1>
            
            <div class="price-display mb-4">
                <div class="current-price display-4 fw-bold text-success">
                    ${{ "%.2f"|format(product.price) }}
                </div>
                {% if product.discount > 0 %}
                <div>
                    <span class="original-price h4 text-muted text-decoration-line-through">
                        ${{ "%.2f"|format(product.original_price) }}
                    </span>
                    <span class="badge bg-danger ms-2 fs-6">{{ product.discount }}% OFF</span>
                </div>
                <div class="text-success">
                    You save ${{ "%.2f"|format(product.original_price - product.price) }}
                </div>
                {% endif %}
            </div>
            
            <div class="product-info mb-4">
                <p><i class="bi bi-star-fill text-warning"></i> {{ product.rating }} / 5.0 ({{ product.reviews }} reviews)</p>
                <p><i class="bi bi-truck"></i> Delivery in {{ product.delivery_days }} days</p>
                {% if product.free_shipping %}
                <p><i class="bi bi-box-seam text-success"></i> Free Shipping Available</p>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2 mb-4">
                <button class="btn btn-lg btn-primary watchlist-btn" 
                        data-product-id="{{ product.id }}"
                        data-product-name="{{ product.name }}"
                        data-marketplace="{{ product.marketplace }}"
                        data-price="{{ product.price }}"
                        data-original-price="{{ product.original_price }}"
                        data-image="{{ product.image }}"
                        data-in-watchlist="{{ product.in_watchlist }}">
                    <i class="bi bi-bookmark{% if product.in_watchlist %}-fill{% endif %}"></i>
                    {% if product.in_watchlist %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}
                </button>
                <a href="{{ product.url }}" class="btn btn-lg btn-warning" target="_blank">
                    View on {{ product.marketplace }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </div>
            
            <div class="ai-insights">
                <h5>ðŸ¤– AI Insights</h5>
                <div class="btn-group w-100 mb-2" role="group">
                    <button class="btn btn-outline-info" id="aiSummaryBtn">Product Summary</button>
                    <button class="btn btn-outline-success" id="buyAdviceBtn">Buy Advice</button>
                    <button class="btn btn-outline-warning" id="reviewCheckBtn">Review Check</button>
                </div>
                <div id="aiResult" class="alert alert-info" style="display:none;"></div>
            </div>
        </div>
    </div>
    
    <div class="row mt-5">
        <div class="col-12">
            <h4>ðŸ“ˆ Price History (Last 30 Days)</h4>
            <canvas id="priceChart" width="400" height="150"></canvas>
            <div id="priceAnalysis" class="mt-3"></div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <h4>Product Description</h4>
            <p>{{ product.description }}</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const productData = {
    id: '{{ product.id }}',
    name: '{{ product.name }}',
    description: '{{ product.description }}',
    price: {{ product.price }},
    discount: {{ product.discount }},
    rating: {{ product.rating }},
    reviews: {{ product.reviews }}
};

const priceHistory = {{ price_history | safe }};

// Draw price chart
const ctx = document.getElementById('priceChart').getContext('2d');
const dates = priceHistory.map(p => p.date);
const prices = priceHistory.map(p => p.price);

const priceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: dates,
        datasets: [{
            label: 'Price ($)',
            data: prices,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: prices.map((price, idx) => {
                if (idx === 0) return 'rgb(75, 192, 192)';
                return price < prices[idx - 1] ? 'green' : price > prices[idx - 1] ? 'red' : 'rgb(75, 192, 192)';
            }),
            pointRadius: 4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '$' + context.parsed.y.toFixed(2);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: function(value) {
                        return '$' + value;
                    }
                }
            }
        }
    }
});

// Price analysis
const minPrice = Math.min(...prices);
const maxPrice = Math.max(...prices);
const currentPrice = prices[prices.length - 1];
const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

let analysisHTML = `
    <div class="row text-center">
        <div class="col-md-3">
            <h6>Current Price</h6>
            <span class="fs-5 fw-bold text-primary">$${currentPrice.toFixed(2)}</span>
        </div>
        <div class="col-md-3">
            <h6>Average Price</h6>
            <span class="fs-5 fw-bold">$${avgPrice.toFixed(2)}</span>
        </div>
        <div class="col-md-3">
            <h6>Lowest Price</h6>
            <span class="fs-5 fw-bold text-success">$${minPrice.toFixed(2)}</span>
        </div>
        <div class="col-md-3">
            <h6>Highest Price</h6>
            <span class="fs-5 fw-bold text-danger">$${maxPrice.toFixed(2)}</span>
        </div>
    </div>
`;
document.getElementById('priceAnalysis').innerHTML = analysisHTML;

// AI Features
document.getElementById('aiSummaryBtn').addEventListener('click', function() {
    const resultDiv = document.getElementById('aiResult');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Generating summary...';
    resultDiv.style.display = 'block';
    
    fetch('/api/ai/summary', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: productData.name,
            description: productData.description
        })
    })
    .then(res => res.json())
    .then(data => {
        resultDiv.innerHTML = '<strong>AI Summary:</strong><br>' + data.summary;
    })
    .catch(err => {
        resultDiv.innerHTML = 'Summary unavailable at the moment.';
    });
});

document.getElementById('buyAdviceBtn').addEventListener('click', function() {
    const resultDiv = document.getElementById('aiResult');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Analyzing...';
    resultDiv.style.display = 'block';
    
    fetch('/api/ai/buy-advice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_price: productData.price,
            discount: productData.discount,
            price_history: priceHistory
        })
    })
    .then(res => res.json())
    .then(data => {
        resultDiv.innerHTML = '<strong>Buy Recommendation:</strong><br>' + data.advice;
    });
});

document.getElementById('reviewCheckBtn').addEventListener('click', function() {
    const resultDiv = document.getElementById('aiResult');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Checking reviews...';
    resultDiv.style.display = 'block';
    
    fetch('/api/ai/review-check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            rating: productData.rating,
            review_count: productData.reviews
        })
    })
    .then(res => res.json())
    .then(data => {
        resultDiv.innerHTML = '<strong>Review Analysis:</strong><br>' + data.result;
    });
});
</script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
{% endblock %}
